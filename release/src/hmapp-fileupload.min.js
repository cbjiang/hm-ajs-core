function fileUploadService(e,l,i,a){var n=a;return{uploadFile:function(e,l,a,t,o,s,r){i.upload({url:n+l+"/"+e+"/upload"+(null==r||""==r?"":"/"+r),method:"POST",data:{file:a}}).then(function(e){"function"==typeof t&&t(e)},function(e){"function"==typeof o&&o(e)},function(e){"function"==typeof s&&s(e)})},deleteFile:function(i){var a=l.defer();return e({method:"POST",url:n+"temp/delete",data:{dir:i.dir,saveNames:i.saveName,systemName:i.systemName}}).success(function(e,l,i,n){a.resolve(e)}).error(function(e,l,i,n){a.reject(e)}),a.promise}}}function FileUploadUtil(){var e=[".png",".jpg",".jpeg",".bmp"],l=[".mp4",".rmvb",".avi",".flv"],i=[".zip",".rar"],a=[".doc",".docx",".pdf",".xls",".xlsx",".ppt",".pptx"];return{getTypeList:function(n){if(null!=n){for(var t=n.split(","),o=[],s=0;s<t.length;s++)switch(t[s]){case"image":o=o.concat(e);break;case"video":o=o.concat(l);break;case"document":o=o.concat(a);break;case"package":o=o.concat(i)}return o.join(",")}return""},getType:function(e){return null!=e&&e.lastIndexOf(".")>=0?"."+e.substring(e.lastIndexOf(".")+1):""},fileSizeToBytes:function(e){if(null!=e){var l=e.split(" "),i=["B","KB","MB","GB","TB","PB","EB","ZB","YB"].indexOf(l[1]);return-1!=i?l[0]*Math.pow(1e3,i):""}return""}}}angular.module("hm.fileupload",["ngFileUpload"]).filter("uriDecode",function(){return function(e){return decodeURI(e)}}).filter("getFileType",function(){return function(e){return""==FileUploadUtil().getType(e).replace(".","")?" ":FileUploadUtil().getType(e).replace(".","").toUpperCase()}}).filter("isImage",function(){return function(e){return["PNG","JPG","JPEG","BMP"].indexOf(""==FileUploadUtil().getType(e).replace(".","")?" ":FileUploadUtil().getType(e).replace(".","").toUpperCase())>=0}}),null!=hmappSystemConfig&&angular.module("hm.fileupload").constant("FILESERVICE",hmappSystemConfig.FILESERVICE).constant("FILESYSTEMNAME",hmappSystemConfig.FILESYSTEMNAME).constant("FILEDIRNAME",hmappSystemConfig.FILEDIRNAME),angular.module("hm.fileupload").service("fileUploadService",fileUploadService),fileUploadService.$inject=["$http","$q","Upload","FILESERVICE"],angular.module("hm.fileupload").directive("hmUploadFile",["$compile","$http","$window","fileUploadService","FILESERVICE","FILEDIRNAME","FILESYSTEMNAME",function(e,l,i,a,n,t,o){return{link:function(l,i,s){function r(e,i,n){var t={};t.fileName=e.name,null!=i&&null!=n?l[v].splice(i,1,t):l[v].push(t),a.uploadFile(p,u,e,function(e){if(null!=e.data){var l=e.data.result.content.list;if(null!=l)for(var i=0;i<l.length;i++)t.dir=l[i].dir,t.fileName=l[i].fileName,t.fileType=l[i].fileType,t.fileurl=l[i].fileurl,t.saveName=l[i].saveName,t.systemName=l[i].systemName;null!=n&&null!=n.fileurl&&a.deleteFile(n).then(function(){console.log("临时文件 删除成功")},function(){console.log("临时文件 删除失败")})}},function(e){console.log("临时文件 上传失败")},function(e){var l=parseInt(100*e.loaded/e.total);t.progress=l+"%",console.log("progress: "+l+"% "+e.config.data.file.name)})}var d=null,f=null,c=n,u=null==s.system||""==s.system?null==o||""==o?"tempSystem":o:s.system,p=null==s.dir||""==s.dir?null==t||""==t?"tempFileDir":t:s.dir,v=s.list,m=parseInt(s.size),g=FileUploadUtil().getTypeList(s.accept),N=s.filesize,y=FileUploadUtil().fileSizeToBytes(N),F="fileupload_edit_"+v,h="fileupload_download_"+v,b="fileupload_delete_"+v;if(null!=v&&""!=v){var E='<div class="file-upload-bar"><div ng-repeat="file in {fileList}" class="file-upload-info"><div ng-if="file.saveName==null" class="file-upload-ing"><div class="file-progress"><div style="margin-top: 30px"><span>{{file.progress}}</span></div><div class="progress progress-striped active "><div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: {{file.progress}}"></div></div></div></div><div ng-if="file.saveName!=null"><div ng-if="(file.fileName | isImage)" class="file-type-img" style="background: url(\'{{file.fileurl==null?\'{fileHost}\'+file.systemName+\'/\'+file.dir+\'/\'+file.saveName+\'/\'+file.fileName:file.fileurl}}\') #000 center no-repeat;"><span class="ng-binding">&nbsp;</span><div class="file-upload-menu file"><div class="menu-btn edit" ng-click="{editFuncName}(file)"></div><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div><div class="menu-btn del" ng-click="{delFuncName}(file)"></div></div></div><div ng-if="!(file.fileName | isImage)" class="file-type-file"><span ng-if="(file.fileName | getFileType)!=\' \'" class="ng-binding">{{file.fileName | getFileType}}</span><span ng-if="(file.fileName | getFileType)==\' \'" class="ng-binding">&nbsp;</span><div class="file-upload-menu file"><div class="menu-btn edit" ng-click="{editFuncName}(file)"></div><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div><div class="menu-btn del" ng-click="{delFuncName}(file)"></div></div><div class="file-name">{{file.fileName | uriDecode}}</div></div></div></div><div class="file-upload-add"></div></div>';E=E.replace(/\{fileList}/g,v).replace("{fileHost}",c).replace(/\{editFuncName}/g,F).replace(/\{downloadFuncName}/g,h).replace(/\{delFuncName}/g,b),null!=l[v]&&l[v].length>0||(l[v]=[]);var I='<input class="hide" type="file" accept="{accept}">';I=null!=g?I.replace("{accept}",g):I.replace("{accept}","");var k=$(I).appendTo(i);k.on("click",function(e){k.val(""),e.stopPropagation()}),i.append(e(E)(l)),k.on("change",function(e){var i=d,a=f;if(d=null,f=null,null==i&&null==a&&l[v].length>=m)toastr.error("最多上传"+m+"个附件!","添加附件-失败");else{var n=e.target.files;console.log(n);for(var t=0;t<n.length;t++){var o=n[t];if(null!=g&&""!=g&&-1==g.split(",").indexOf(FileUploadUtil().getType(o.name)))return void toastr.error("请上传"+g.replace(/,/g," ")+"类型的附件!","添加附件-失败");if(null!=y&&""!=y&&o.size>y)return void toastr.error("上传的附件大小不能超过"+N+"!","添加附件-失败");r(o,i,a)}}}),i.find(".file-upload-add").on("click",function(){k.click()}),void 0===l[b]&&(l[b]=function(e){for(var i=0;i<l[v].length;i++)if(e.saveName==l[v][i].saveName){null!=e.fileurl?a.deleteFile(e).then(function(){l[v].splice(i,1),console.log("临时文件 删除成功")},function(){console.log("临时文件 删除失败")}):l[v].splice(i,1);break}}),void 0===l[h]&&(l[h]=function(e){for(var i="",a=0;a<l[v].length;a++)if(e.saveName==l[v][a].saveName){i=null!=e.fileurl?e.fileurl:c+e.systemName+"/"+e.dir+"/"+e.saveName+"/"+e.fileName;break}var n=document.createElement("iframe");n.src=i,n.style.display="none",n.onload=function(){""==this.textContent&&toastr.error("文件下载失败！","文件下载")},document.body.appendChild(n)}),void 0===l[F]&&(l[F]=function(e){for(var i=0;i<l[v].length;i++)if(e.saveName==l[v][i].saveName){d=i,f=e,k.click();break}})}}}}]),angular.module("hm.fileupload").directive("hmUploadFileDetail",["$compile","$http","$window","fileUploadService","FILESERVICE","FILEDIRNAME",function(e,l,i,a,n,t){return{link:function(l,i,a){var t=n,o=(null==a.dir||""==a.dir||a.dir,a.list),s="fileupload_download_"+o;if(null!=o&&""!=o){var r='<div class="file-upload-bar"><div ng-repeat="file in {fileList}" class="file-upload-info detail"><div ng-if="file.saveName!=null"><div ng-if="(file.fileName | isImage)" class="file-type-img" style="background: url(\'{{file.fileurl==null?\'{fileHost}\'+file.systemName+\'/\'+file.dir+\'/\'+file.saveName+\'/\'+file.fileName:file.fileurl}}\') #000 center no-repeat;"><span class="ng-binding">&nbsp;</span><div class="file-upload-menu file"><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div></div></div><div ng-if="!(file.fileName | isImage)" class="file-type-file"><span ng-if="(file.fileName | getFileType)!=\' \'" class="ng-binding">{{file.fileName | getFileType}}</span><span ng-if="(file.fileName | getFileType)==\' \'" class="ng-binding">&nbsp;</span><div class="file-upload-menu file"><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div></div><div class="file-name">{{file.fileName | uriDecode}}</div></div></div></div></div>';r=r.replace(/\{fileList}/g,o).replace("{fileHost}",t).replace(/\{downloadFuncName}/g,s),null!=l[o]&&l[o].length>0||(l[o]=[]),i.append(e(r)(l))}void 0===l[s]&&(l[s]=function(e){for(var i="",a=0;a<l[o].length;a++)if(e.saveName==l[o][a].saveName){i=null!=e.fileurl?e.fileurl:t+e.systemName+"/"+e.dir+"/"+e.saveName+"/"+e.fileName;break}var n=document.createElement("iframe");n.src=i,n.style.display="none",n.onload=function(){""==this.textContent&&toastr.error("文件下载失败！","文件下载")},document.body.appendChild(n)})}}}]),angular.module("hm.fileupload").directive("hmUploadImage",["$compile","$http","$window","fileUploadService","FILESERVICE","FILEDIRNAME","FILESYSTEMNAME",function(e,l,i,a,n,t,o){return{link:function(l,i,s){function r(e,i,n){var t={};t.fileName=e.name,null!=i&&null!=n?l[g].splice(i,1,t):l[g].push(t),a.uploadFile(m,v,e,function(e){if(null!=e.data){var l=e.data.result.content.list;if(null!=l)for(var i=0;i<l.length;i++)t.dir=l[i].dir,t.fileName=l[i].fileName,t.fileType=l[i].fileType,t.fileurl=l[i].fileurl,t.saveName=l[i].saveName,t.systemName=l[i].systemName,null!=l[i].comSaveNames&&(t.comSaveNames=l[i].comSaveNames),t.isCover=0;null!=n&&null!=n.fileurl&&a.deleteFile(n).then(function(){console.log("临时文件 删除成功")},function(){console.log("临时文件 删除失败")})}},function(e){console.log("临时文件 上传失败")},function(e){var l=parseInt(100*e.loaded/e.total);t.progress=l+"%",console.log("progress: "+l+"% "+e.config.data.file.name)},d)}console.log(s);var d=s.hmUploadImage,f="";null!=d&&""!=d&&(f=d.split(",")[0].split(":")[0].replace("*","_")+"_");var c=null,u=null,p=n,v=null==s.system||""==s.system?null==o||""==o?"tempSystem":o:s.system,m=null==s.dir||""==s.dir?null==t||""==t?"tempImgDir":t:s.dir,g=s.list,N=parseInt(s.size),y=FileUploadUtil().getTypeList("image"),F=s.filesize,h=FileUploadUtil().fileSizeToBytes(F),b="fileupload_cover_"+g,E="fileupload_edit_"+g,I="fileupload_download_"+g,k="fileupload_delete_"+g;if(null!=g&&""!=g){var S='<div class="file-upload-bar"><div ng-repeat="file in {fileList}" class="file-upload-info"><div ng-if="file.saveName==null" class="file-upload-ing"><div class="file-progress"><div style="margin-top: 30px"><span>{{file.progress}}</span></div><div class="progress progress-striped active "><div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: {{file.progress}}"></div></div></div></div><div ng-if="file.saveName!=null"><div class="file-type-img" style="background: url(\'{{file.fileurl==null?\'{fileHost}\'+file.systemName+\'/\'+file.dir+\'/{dpiStr}\'+file.saveName+\'/\'+file.fileName:file.fileurl}}\') #000 center no-repeat;"><span class="ng-binding">&nbsp;</span><div class="file-upload-menu"><div class="menu-btn cover" ng-class="{\'active\':file.isCover==1}" ng-click="{coverFuncName}(file)"></div><div class="menu-btn edit" ng-click="{editFuncName}(file)"></div><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div><div class="menu-btn del" ng-click="{delFuncName}(file)"></div></div><div ng-if="file.isCover==1" class="cover-tab"></div></div></div></div><div class="file-upload-add image"></div></div>';S=S.replace(/\{fileList}/g,g).replace("{fileHost}",p).replace(/\{coverFuncName}/g,b).replace(/\{editFuncName}/g,E).replace(/\{downloadFuncName}/g,I).replace(/\{delFuncName}/g,k).replace(/\{dpiStr}/g,f),null!=l[g]&&l[g].length>0||(l[g]=[]);var U='<input class="hide" type="file" accept="{accept}">';U=null!=y?U.replace("{accept}",y):U.replace("{accept}","");var w=$(U).appendTo(i);w.on("click",function(e){w.val(""),e.stopPropagation()}),i.append(e(S)(l)),w.on("change",function(e){var i=c,a=u;if(c=null,u=null,null==i&&null==a&&l[g].length>=N)toastr.error("最多上传"+N+"个附件!","添加附件-失败");else for(var n=e.target.files,t=0;t<n.length;t++){var o=n[t];if(null!=y&&""!=y&&-1==y.split(",").indexOf(FileUploadUtil().getType(o.name)))return void toastr.error("请上传"+y.replace(/,/g," ")+"类型的附件!","添加附件-失败");if(null!=h&&""!=h&&o.size>h)return void toastr.error("上传的附件大小不能超过"+F+"!","添加附件-失败");r(o,i,a)}}),i.find(".file-upload-add").on("click",function(){w.click()}),void 0===l[k]&&(l[k]=function(e){for(var i=0;i<l[g].length;i++)if(e.saveName==l[g][i].saveName){null!=e.fileurl?a.deleteFile(e).then(function(){l[g].splice(i,1),console.log("临时文件 删除成功")},function(){console.log("临时文件 删除失败")}):l[g].splice(i,1);break}}),void 0===l[I]&&(l[I]=function(e){for(var i="",a=0;a<l[g].length;a++)if(e.saveName==l[g][a].saveName){i=null!=e.fileurl?e.fileurl:p+e.systemName+"/"+e.dir+"/"+e.saveName+"/"+e.fileName;break}var n=document.createElement("iframe");n.src=i,n.style.display="none",n.onload=function(){""==this.textContent&&toastr.error("文件下载失败！","文件下载")},document.body.appendChild(n)}),void 0===l[E]&&(l[E]=function(e){for(var i=0;i<l[g].length;i++)if(e.saveName==l[g][i].saveName){c=i,u=e,w.click();break}}),void 0===l[b]&&(l[b]=function(e){for(var i=0;i<l[g].length;i++)e.saveName==l[g][i].saveName?l[g][i].isCover=1:l[g][i].isCover=0})}}}}]),angular.module("hm.fileupload").directive("hmUploadImageDetail",["$compile","$http","$window","fileUploadService","FILESERVICE","FILEDIRNAME",function(e,l,i,a,n,t){return{link:function(l,i,a){var t=a.hmUploadImageDetail,o="";null!=t&&""!=t&&(o=t.replace("*","_")+"_");var s=n,r=(null==a.dir||""==a.dir||a.dir,a.list),d="fileupload_download_"+r;if(null!=r&&""!=r){var f='<div class="file-upload-bar"><div ng-repeat="file in {fileList}" class="file-upload-info detail"><div ng-if="file.saveName!=null"><div class="file-type-img" style="background: url(\'{{file.fileurl==null?\'{fileHost}\'+file.systemName+\'/\'+file.dir+\'/{dpiStr}\'+file.saveName+\'/\'+file.fileName:file.fileurl}}\') #000 center no-repeat;"><span class="ng-binding">&nbsp;</span><div class="file-upload-menu"><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div></div><div ng-if="file.isCover==1" class="cover-tab"></div></div></div></div></div>';f=f.replace(/\{fileList}/g,r).replace("{fileHost}",s).replace(/\{downloadFuncName}/g,d).replace(/\{dpiStr}/g,o),null!=l[r]&&l[r].length>0||(l[r]=[]),i.append(e(f)(l))}void 0===l[d]&&(l[d]=function(e){for(var i="",a=0;a<l[r].length;a++)if(e.saveName==l[r][a].saveName){i=null!=e.fileurl?e.fileurl:s+e.systemName+"/"+e.dir+"/"+e.saveName+"/"+e.fileName;break}var n=document.createElement("iframe");n.src=i,n.style.display="none",n.onload=function(){""==this.textContent&&toastr.error("文件下载失败！","文件下载")},document.body.appendChild(n)})}}}]);