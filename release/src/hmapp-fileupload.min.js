function fileUploadService(e,l,i,a){var n=a;return{uploadFile:function(e,l,a,o,d,s,r){i.upload({url:n+l+"/"+e+"/upload"+(null==r||""==r?"":"/"+r),method:"POST",data:{file:a}}).then(function(e){"function"==typeof o&&o(e)},function(e){"function"==typeof d&&d(e)},function(e){"function"==typeof s&&s(e)})},deleteFile:function(i){var a=l.defer();return e({method:"POST",url:n+"temp/delete",data:{dir:i.dir,saveNames:i.saveName,systemName:i.systemName}}).success(function(e,l,i,n){a.resolve(e)}).error(function(e,l,i,n){a.reject(e)}),a.promise}}}function FileUploadUtil(){var e=[".png",".jpg",".jpeg",".bmp"],l=[".mp4",".rmvb",".avi",".flv"],i=[".zip",".rar"],a=[".doc",".docx",".pdf",".xls",".xlsx",".ppt",".pptx"];return{getTypeList:function(n){if(null!=n){for(var o=n.split(","),d=[],s=0;s<o.length;s++)switch(o[s]){case"image":d=d.concat(e);break;case"video":d=d.concat(l);break;case"document":d=d.concat(a);break;case"package":d=d.concat(i)}return d.join(",")}return""},getType:function(e){return null!=e&&e.lastIndexOf(".")>=0?"."+e.substring(e.lastIndexOf(".")+1):""},fileSizeToBytes:function(e){if(null!=e){var l=e.split(" "),i=["B","KB","MB","GB","TB","PB","EB","ZB","YB"].indexOf(l[1]);return-1!=i?l[0]*Math.pow(1e3,i):""}return""}}}angular.module("hm.fileupload",["ngFileUpload"]).filter("uriDecode",function(){return function(e){return decodeURI(e)}}).filter("getFileType",function(){return function(e){return""==FileUploadUtil().getType(e).replace(".","")?" ":FileUploadUtil().getType(e).replace(".","").toUpperCase()}}).filter("isImage",function(){return function(e){return["PNG","JPG","JPEG","BMP"].indexOf(""==FileUploadUtil().getType(e).replace(".","")?" ":FileUploadUtil().getType(e).replace(".","").toUpperCase())>=0}}).filter("backgroundUrl",["FILESERVICE",function(e){return function(l){return null==l.fileurl?e+l.systemName+"/"+l.dir+"/"+l.saveName+"/"+l.fileName:l.fileurl}}]),null!=hmappSystemConfig&&angular.module("hm.fileupload").constant("FILESERVICE",hmappSystemConfig.FILESERVICE).constant("FILESYSTEMNAME",hmappSystemConfig.FILESYSTEMNAME).constant("FILEDIRNAME",hmappSystemConfig.FILEDIRNAME),angular.module("hm.fileupload").service("fileUploadService",fileUploadService),fileUploadService.$inject=["$http","$q","Upload","FILESERVICE"],angular.module("hm.fileupload").directive("hmUploadFile",["$compile","$http","$window","fileUploadService","FILESERVICE","FILEDIRNAME","FILESYSTEMNAME",function(e,l,i,a,n,o,d){return{scope:{ngModel:"="},require:"?ngModel",link:function(l,i,s,r){function t(e,l,i){var n={};n.fileName=e.name,null!=l&&null!=i?r.$modelValue.splice(l,1,n):r.$modelValue.push(n),a.uploadFile(m,p,e,function(e){if(null!=e.data){var l=e.data.result.content.list;if(null!=l)for(var o=0;o<l.length;o++)n.dir=l[o].dir,n.fileName=l[o].fileName,n.fileType=l[o].fileType,n.fileurl=l[o].fileurl,n.saveName=l[o].saveName,n.systemName=l[o].systemName;null!=i&&null!=i.fileurl&&a.deleteFile(i).then(function(){console.log("临时文件 删除成功")},function(){console.log("临时文件 删除失败")})}},function(e){console.log("临时文件 上传失败")},function(e){var l=parseInt(100*e.loaded/e.total);n.progress=l+"%",console.log("progress: "+l+"% "+e.config.data.file.name)})}if(r){var u=null,c=null,f=n,p=null==s.system||""==s.system?null==d||""==d?"tempSystem":d:s.system,m=null==s.dir||""==s.dir?null==o||""==o?"tempFileDir":o:s.dir,v=parseInt(s.size),g=FileUploadUtil().getTypeList(s.accept),N=s.filesize,y=FileUploadUtil().fileSizeToBytes(N),F='<div class="file-upload-bar"><div ng-repeat="file in ngModel" class="file-upload-info"><div ng-if="file.saveName==null" class="file-upload-ing"><div class="file-progress"><div style="margin-top: 30px"><span>{{file.progress}}</span></div><div class="progress progress-striped active "><div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: {{file.progress}}"></div></div></div></div><div ng-if="file.saveName!=null"><div ng-if="(file.fileName | isImage)" class="file-type-img" style="background: url(\'{{file | backgroundUrl }}\') #000 center no-repeat;"><span class="ng-binding">&nbsp;</span><div class="file-upload-menu file"><div class="arrow"></div><div class="menu-btn edit" ng-click="{editFuncName}(file)"></div><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div><div class="menu-btn del" ng-click="{delFuncName}(file)"></div></div></div><div ng-if="!(file.fileName | isImage)" class="file-type-file"><span ng-if="(file.fileName | getFileType)!=\' \'" class="ng-binding">{{file.fileName | getFileType}}</span><span ng-if="(file.fileName | getFileType)==\' \'" class="ng-binding">&nbsp;</span><div class="file-upload-menu file"><div class="arrow"></div><div class="menu-btn edit" ng-click="{editFuncName}(file)"></div><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div><div class="menu-btn del" ng-click="{delFuncName}(file)"></div></div><div class="file-name">{{file.fileName | uriDecode}}</div></div></div></div><div class="file-upload-add"></div></div>';F=F.replace("{fileHost}",f).replace(/\{editFuncName}/g,"fileupload_edit").replace(/\{downloadFuncName}/g,"fileupload_download").replace(/\{delFuncName}/g,"fileupload_delete");var b='<input class="hide" type="file" accept="{accept}">';b=null!=g?b.replace("{accept}",g):b.replace("{accept}","");var h=$(b).appendTo(i);h.on("click",function(e){h.val(""),e.stopPropagation()}),i.append(e(F)(l)),h.on("change",function(e){null!=r.$modelValue&&r.$modelValue.length>0||r.$setViewValue([]);var l=u,i=c;if(u=null,c=null,null==l&&null==i&&r.$modelValue.length>=v)toastr.error("最多上传"+v+"个附件!","添加附件-失败");else for(var a=e.target.files,n=0;n<a.length;n++){var o=a[n];if(null!=g&&""!=g&&-1==g.split(",").indexOf(FileUploadUtil().getType(o.name)))return void toastr.error("请上传"+g.replace(/,/g," ")+"类型的附件!","添加附件-失败");if(null!=y&&""!=y&&o.size>y)return void toastr.error("上传的附件大小不能超过"+N+"!","添加附件-失败");t(o,l,i)}}),i.find(".file-upload-add").on("click",function(){h.click()}),void 0===l.fileupload_delete&&(l.fileupload_delete=function(e){for(var l=0;l<r.$modelValue.length;l++)if(e.saveName==r.$modelValue[l].saveName){null!=e.fileurl?a.deleteFile(e).then(function(){r.$modelValue.splice(l,1),console.log("临时文件 删除成功")},function(){console.log("临时文件 删除失败")}):r.$modelValue.splice(l,1);break}}),void 0===l.fileupload_download&&(l.fileupload_download=function(e){for(var l="",i=0;i<r.$modelValue.length;i++)if(e.saveName==r.$modelValue[i].saveName){l=null!=e.fileurl?e.fileurl:f+e.systemName+"/"+e.dir+"/"+e.saveName+"/"+e.fileName;break}var a=document.createElement("iframe");a.src=l,a.style.display="none",document.body.appendChild(a)}),void 0===l.fileupload_edit&&(l.fileupload_edit=function(e){for(var l=0;l<r.$modelValue.length;l++)if(e.saveName==r.$modelValue[l].saveName){u=l,c=e,h.click();break}})}}}}]),angular.module("hm.fileupload").directive("hmUploadFileDetail",["$compile","$http","$window","fileUploadService","FILESERVICE","FILEDIRNAME",function(e,l,i,a,n,o){return{scope:{ngModel:"="},require:"?ngModel",link:function(l,i,a,o){if(o){var d=n,s='<div class="file-upload-bar"><div ng-repeat="file in ngModel" class="file-upload-info detail"><div ng-if="file.saveName!=null"><div ng-if="(file.fileName | isImage)" class="file-type-img" style="background: url(\'{{file | backgroundUrl }}\') #000 center no-repeat;"><span class="ng-binding">&nbsp;</span><div class="file-upload-menu file"><div class="arrow"></div><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div></div></div><div ng-if="!(file.fileName | isImage)" class="file-type-file"><span ng-if="(file.fileName | getFileType)!=\' \'" class="ng-binding">{{file.fileName | getFileType}}</span><span ng-if="(file.fileName | getFileType)==\' \'" class="ng-binding">&nbsp;</span><div class="file-upload-menu file"><div class="arrow"></div><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div></div><div class="file-name">{{file.fileName | uriDecode}}</div></div></div></div></div>';s=s.replace("{fileHost}",d).replace(/\{downloadFuncName}/g,"fileupload_download"),i.append(e(s)(l)),void 0===l.fileupload_download&&(l.fileupload_download=function(e){if(null!=o.$modelValue&&o.$modelValue.length>0){for(var l="",i=0;i<o.$modelValue.length;i++)if(e.saveName==o.$modelValue[i].saveName){l=null!=e.fileurl?e.fileurl:d+e.systemName+"/"+e.dir+"/"+e.saveName+"/"+e.fileName;break}var a=document.createElement("iframe");a.src=l,a.style.display="none",document.body.appendChild(a)}})}}}}]),angular.module("hm.fileupload").directive("hmUploadImage",["$compile","$http","$window","fileUploadService","FILESERVICE","FILEDIRNAME","FILESYSTEMNAME",function(e,l,i,a,n,o,d){return{scope:{ngModel:"="},require:"?ngModel",link:function(l,i,s,r){function t(e,l,i){var n={};n.fileName=e.name,null!=l&&null!=i?r.$modelValue.splice(l,1,n):r.$modelValue.push(n),a.uploadFile(g,v,e,function(e){if(null!=e.data){var l=e.data.result.content.list;if(null!=l)for(var o=0;o<l.length;o++)n.dir=l[o].dir,n.fileName=l[o].fileName,n.fileType=l[o].fileType,n.fileurl=l[o].fileurl,n.saveName=l[o].saveName,n.systemName=l[o].systemName,null!=l[o].comSaveNames&&(n.comSaveNames=l[o].comSaveNames),n.isCover=0;null!=i&&null!=i.fileurl&&a.deleteFile(i).then(function(){console.log("临时文件 删除成功")},function(){console.log("临时文件 删除失败")})}},function(e){console.log("临时文件 上传失败")},function(e){var l=parseInt(100*e.loaded/e.total);n.progress=l+"%",console.log("progress: "+l+"% "+e.config.data.file.name)},u)}if(r){var u=s.hmUploadImage,c="";null!=u&&""!=u&&(c=u.split(",")[0].split(":")[0].replace("*","_")+"_");var f=null,p=null,m=n,v=null==s.system||""==s.system?null==d||""==d?"tempSystem":d:s.system,g=null==s.dir||""==s.dir?null==o||""==o?"tempImgDir":o:s.dir,N=parseInt(s.size),y=FileUploadUtil().getTypeList("image"),F=s.filesize,b=FileUploadUtil().fileSizeToBytes(F),h='<div class="file-upload-bar"><div ng-repeat="file in ngModel" class="file-upload-info"><div ng-if="file.saveName==null" class="file-upload-ing"><div class="file-progress"><div style="margin-top: 30px"><span>{{file.progress}}</span></div><div class="progress progress-striped active "><div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: {{file.progress}}"></div></div></div></div><div ng-if="file.saveName!=null"><div class="file-type-img" style="background: url(\'{{file | backgroundUrl }}\') #000 center no-repeat;"><span class="ng-binding">&nbsp;</span><div class="file-upload-menu"><div class="arrow"></div><div class="menu-btn cover" ng-class="{\'active\':file.isCover==1}" ng-click="{coverFuncName}(file)"></div><div class="menu-btn edit" ng-click="{editFuncName}(file)"></div><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div><div class="menu-btn del" ng-click="{delFuncName}(file)"></div></div><div ng-if="file.isCover==1" class="cover-tab"></div></div></div></div><div class="file-upload-add image"></div></div>';h=h.replace("{fileHost}",m).replace(/\{coverFuncName}/g,"fileupload_cover").replace(/\{editFuncName}/g,"fileupload_edit").replace(/\{downloadFuncName}/g,"fileupload_download").replace(/\{delFuncName}/g,"fileupload_delete").replace(/\{dpiStr}/g,c);var E='<input class="hide" type="file" accept="{accept}">';E=null!=y?E.replace("{accept}",y):E.replace("{accept}","");var V=$(E).appendTo(i);V.on("click",function(e){V.val(""),e.stopPropagation()}),i.append(e(h)(l)),V.on("change",function(e){null!=r.$modelValue&&r.$modelValue.length>0||r.$setViewValue([]);var l=f,i=p;if(f=null,p=null,null==l&&null==i&&r.$modelValue.length>=N)toastr.error("最多上传"+N+"个附件!","添加附件-失败");else for(var a=e.target.files,n=0;n<a.length;n++){var o=a[n];if(null!=y&&""!=y&&-1==y.split(",").indexOf(FileUploadUtil().getType(o.name)))return void toastr.error("请上传"+y.replace(/,/g," ")+"类型的附件!","添加附件-失败");if(null!=b&&""!=b&&o.size>b)return void toastr.error("上传的附件大小不能超过"+F+"!","添加附件-失败");t(o,l,i)}}),i.find(".file-upload-add").on("click",function(){V.click()}),void 0===l.fileupload_delete&&(l.fileupload_delete=function(e){for(var l=0;l<r.$modelValue.length;l++)if(e.saveName==r.$modelValue[l].saveName){null!=e.fileurl?a.deleteFile(e).then(function(){r.$modelValue.splice(l,1),console.log("临时文件 删除成功")},function(){console.log("临时文件 删除失败")}):r.$modelValue.splice(l,1);break}}),void 0===l.fileupload_download&&(l.fileupload_download=function(e){for(var l="",i=0;i<r.$modelValue.length;i++)if(e.saveName==r.$modelValue[i].saveName){l=null!=e.fileurl?e.fileurl:m+e.systemName+"/"+e.dir+"/"+e.saveName+"/"+e.fileName;break}var a=document.createElement("iframe");a.src=l,a.style.display="none",document.body.appendChild(a)}),void 0===l.fileupload_edit&&(l.fileupload_edit=function(e){for(var l=0;l<r.$modelValue.length;l++)if(e.saveName==r.$modelValue[l].saveName){f=l,p=e,V.click();break}}),void 0===l.fileupload_cover&&(l.fileupload_cover=function(e){for(var l=0;l<r.$modelValue.length;l++)e.saveName==r.$modelValue[l].saveName&&1!=r.$modelValue[l].isCover?r.$modelValue[l].isCover=1:r.$modelValue[l].isCover=0})}}}}]),angular.module("hm.fileupload").directive("hmUploadImageDetail",["$compile","$http","$window","fileUploadService","FILESERVICE","FILEDIRNAME",function(e,l,i,a,n,o){return{scope:{ngModel:"="},require:"?ngModel",link:function(l,i,a,o){if(o){var d=a.hmUploadImageDetail,s="";null!=d&&""!=d&&(s=d.replace("*","_")+"_");var r=n,t='<div class="file-upload-bar"><div ng-repeat="file in ngModel" class="file-upload-info detail"><div ng-if="file.saveName!=null"><div class="file-type-img" style="background: url(\'{{file | backgroundUrl }}\') #000 center no-repeat;"><span class="ng-binding">&nbsp;</span><div class="file-upload-menu"><div class="arrow"></div><div class="menu-btn download" ng-click="{downloadFuncName}(file)"></div></div><div ng-if="file.isCover==1" class="cover-tab"></div></div></div></div></div>';t=t.replace("{fileHost}",r).replace(/\{downloadFuncName}/g,"fileupload_download").replace(/\{dpiStr}/g,s),i.append(e(t)(l)),void 0===l.fileupload_download&&(l.fileupload_download=function(e){if(null!=o.$modelValue&&o.$modelValue.length>0){for(var l="",i=0;i<o.$modelValue.length;i++)if(e.saveName==o.$modelValue[i].saveName){l=null!=e.fileurl?e.fileurl:r+e.systemName+"/"+e.dir+"/"+e.saveName+"/"+e.fileName;break}var a=document.createElement("iframe");a.src=l,a.style.display="none",document.body.appendChild(a)}})}}}}]);